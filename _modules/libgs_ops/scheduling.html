

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>libgs_ops.scheduling &mdash; libgs_ops  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> libgs_ops
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs_ops.propagator.mpl_plot_pass.html">libgs_ops.propagator.mpl_plot_pass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs_ops.propagator.Propagator.html">libgs_ops.propagator.Propagator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs_ops.propagator.SpaceTrackAPI.html">libgs_ops.propagator.SpaceTrackAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs_ops.propagator.TLEDb.html">libgs_ops.propagator.TLEDb</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs_ops.propagator.Error.html">libgs_ops.propagator.Error</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs_ops.scheduling.Action.html">libgs_ops.scheduling.Action</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs_ops.scheduling.CommsPass.html">libgs_ops.scheduling.CommsPass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs_ops.scheduling.Communication.html">libgs_ops.scheduling.Communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs_ops.scheduling.RPCSchedulerClient.html">libgs_ops.scheduling.RPCSchedulerClient</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs_ops.scheduling.Schedule.html">libgs_ops.scheduling.Schedule</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs_ops.scheduling.Error.html">libgs_ops.scheduling.Error</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs_ops.rpc.RPCClient.html">libgs_ops.rpc.RPCClient</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">libgs_ops</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>libgs_ops.scheduling</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for libgs_ops.scheduling</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">..</span>
<span class="sd">    Copyright Â© 2017-2018 The University of New South Wales</span>

<span class="sd">    Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="sd">    this software and associated documentation files (the &quot;Software&quot;), to deal in</span>
<span class="sd">    the Software without restriction, including without limitation the rights to use,</span>
<span class="sd">    copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the</span>
<span class="sd">    Software, and to permit persons to whom the Software is furnished to do so,</span>
<span class="sd">    subject to the following conditions:</span>

<span class="sd">    The above copyright notice and this permission notice shall be included in all</span>
<span class="sd">    copies or substantial portions of the Software.</span>

<span class="sd">    THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="sd">    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="sd">    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="sd">    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,</span>
<span class="sd">    WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="sd">    CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>

<span class="sd">    Except as contained in this notice, the name or trademarks of a copyright holder</span>

<span class="sd">    shall not be used in advertising or otherwise to promote the sale, use or other</span>
<span class="sd">    dealings in this Software without prior written authorization of the copyright</span>
<span class="sd">    holder.</span>

<span class="sd">    UNSW is a trademark of The University of New South Wales.</span>


<span class="sd">libgs_ops.scheduling</span>
<span class="sd">=====================</span>

<span class="sd">:date: Sun Aug  6 17:36:19 2017</span>
<span class="sd">:author: kjetil</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="k">import</span> <span class="n">DataFrame</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">ephem</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">rpc</span> <span class="k">import</span> <span class="n">RPCClient</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;libgs_ops-log&#39;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NullHandler</span><span class="p">())</span>



<span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">SCHEDULE_BUFFERTIME</span> <span class="o">=</span> <span class="mi">180</span>



<span class="k">class</span> <span class="nc">Action</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Actions are just a list and/or dict</span>
<span class="sd">    of parameters that will be passed unmodified to the protocol.</span>

<span class="sd">    It can be useful if issuing non-standard commands (ie not bytearrays)</span>
<span class="sd">    to the protocol class for whatever reason.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;unnamed&quot;</span><span class="p">,</span>  <span class="n">retries</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            args:    A list of arguments to pass to the :class:`libgs.protocols.ProtocolBase.do_action` function as positional arguments</span>
<span class="sd">            kwargs:  A dictionary to pass to the :class:`libgs.protocols.ProtocolBase.do_action` function as kwargs.</span>
<span class="sd">            desc:    The description of the action</span>
<span class="sd">            retries: The number of times to retry the action in case of failure.</span>

<span class="sd">        .. note::</span>

<span class="sd">            It is discouraged to use any positional arguments in the do_action function besides one, which is the</span>
<span class="sd">            action selector. Then use kwargs for anything else. See  :class:`libgs.protocols.ProtocolBase` for additional</span>
<span class="sd">            information on this topic.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;args must be a tuple, not </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;kwargs must be a dict, not </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>

        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="c1"># Make something persist through the pass by setting retries to be</span>
        <span class="c1"># realy large, and allow the user to say retries=-1 for convenience.</span>
        <span class="k">if</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">retries</span> <span class="o">=</span>  <span class="mi">10000000</span>

        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;retries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">retries</span><span class="p">)</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;All arguments to Action have to be json-serializable objects. Refer to python documentation (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;Action: </span><span class="si">%s</span><span class="s2"> &lt;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&gt; (</span><span class="si">%d</span><span class="s2"> retries)&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;retries&#39;</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the action to python dictionary format</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Communication</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class holds the message (fully encoded) that is sent to the</span>
<span class="sd">    satellite.</span>

<span class="sd">    It is just a convenience class that wraps and populates a dictionary</span>
<span class="sd">    properly for use by the other classes in this module.</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cmd</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">wait</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            cmd (string or bytearray): Command string (fully encoded) to send</span>
<span class="sd">            to satellite.</span>
<span class="sd">            retries (int): Number of times the command should be retried in</span>
<span class="sd">            case of failure</span>
<span class="sd">            wait (bool): Whether the ground station should wait for a reply</span>
<span class="sd">            from the satellite or not.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_cmdstr</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">hexstr</span> <span class="o">=</span> <span class="n">cmd</span>
            <span class="n">barray</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="n">hexstr</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%02X</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">])</span>
            <span class="n">barray</span> <span class="o">=</span> <span class="n">cmd</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">Communication</span><span class="p">):</span>
            <span class="n">hexstr</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;hexstr&#39;</span><span class="p">]</span>
            <span class="n">barray</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;barray&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Unsupported argument : </span><span class="si">%s</span><span class="s1"> -  </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">cmd</span><span class="p">)))</span>


        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">retries</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span> <span class="ow">or</span> <span class="n">retries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Retries must be an integer &gt; 0&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;barray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">barray</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;hexstr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hexstr</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;retries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">retries</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;wait&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wait</span>


    <span class="k">def</span> <span class="nf">_check_cmdstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the command string is in the right format</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="s1">&#39;0123456789ABCDEF-&#39;</span>

        <span class="c1"># do some input checking</span>
        <span class="c1"># cmd must be in format XX-XX-XX-XX</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)])</span>  <span class="o">==</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;cmd srting must be in the format XX-XX-XX-XX&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span> <span class="ow">in</span> <span class="n">valid</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;cmd string invalid hex&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the class to a python dictionary format</span>
<span class="sd">        Returns:</span>
<span class="sd">            A dictionary</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Turn to serialisable dict... we get rid of bytearray entry.</span>
        <span class="n">c</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">hexstr</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;hexstr&#39;</span><span class="p">],</span> <span class="n">retries</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;retries&#39;</span><span class="p">],</span> <span class="n">wait</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;wait&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">c</span>




<span class="k">class</span> <span class="nc">CommsPass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to hold a communications pass</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_metadata</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pass_data</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">comms</span><span class="o">=</span><span class="p">[],</span> <span class="n">listen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args;</span>
<span class="sd">            pass_data (): Pandas DataFrame with at least az, el, range_rate columns</span>
<span class="sd">            nid (int)   : Norad ID to associate with pass. Can be left empty if pass_data has a .nid field.</span>
<span class="sd">            horizon (float): The lowest acceptable elevation for the pass. Pass_data will be cropped to the horizon</span>
<span class="sd">            comms (list, optional) : List of communications (can be added with add_communications instead)</span>
<span class="sd">            listen (bool, optional): Whether it is a listen pass or not</span>
<span class="sd">            tle (str, optional)    : The TLE used for computing pass_data</span>
<span class="sd">            protocol (str, optional): The protocol to use during the pass</span>
<span class="sd">            **kwargs: Any other key=value pair to pass to scheduler to be logged</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NOTE: Internally, picklable arguments (i.e. everything except pass_data and comms) are</span>
        <span class="c1">#       stored in metadata dictionary so it can be easily converted</span>
        <span class="c1">#       to dict/json, regardless of what is being passed.</span>

        <span class="c1">#initialising _metadata attribute is a bit tricky since we have overloaded __setattr__</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_metadata&#39;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;az&#39;</span> <span class="ow">in</span> <span class="n">pass_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;el&#39;</span><span class="ow">in</span> <span class="n">pass_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;range_rate&#39;</span> <span class="ow">in</span> <span class="n">pass_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;tstamp_str&#39;</span><span class="ow">in</span> <span class="n">pass_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="c1">#print(pass_data.head())</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Pass_data must be a dataframe with at least &quot;az&quot;, &quot;el&quot;, &quot;range_rate&quot; and &quot;tstamp_str&quot; columns&#39;</span><span class="p">)</span>

        <span class="c1"># Initiate named metadata fields) - afterwareds we can access with . operator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;nid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#&lt;--- initialise metadata - will then be set correctly with .nid access immediately below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;listen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">listen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">horizon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">desc</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pass_data</span><span class="p">,</span> <span class="s1">&#39;TLE&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;tle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;tle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pass_data</span><span class="o">.</span><span class="n">TLE</span>


        <span class="c1">#</span>
        <span class="c1"># Check NID</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">nid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pass_data</span><span class="p">,</span> <span class="s1">&#39;nid&#39;</span><span class="p">):</span>

                <span class="k">if</span> <span class="s1">&#39;norad_id&#39;</span> <span class="ow">in</span> <span class="n">pass_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">pd_nid</span> <span class="o">=</span> <span class="n">pass_data</span><span class="o">.</span><span class="n">norad_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pd_nid</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pd_nid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pass_data</span><span class="o">.</span><span class="n">nid</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;nid is set as an attribute on pass_data and also as a norad_id column, but there is a mismatch&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">nid</span><span class="o">=</span><span class="n">pass_data</span><span class="o">.</span><span class="n">nid</span>

            <span class="k">elif</span> <span class="s1">&#39;norad_id&#39;</span> <span class="ow">in</span> <span class="n">pass_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pd_nid</span> <span class="o">=</span> <span class="n">pass_data</span><span class="o">.</span><span class="n">norad_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pd_nid</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;norad_id column is available in pass_data, but not unique - it should be&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">pd_nid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Norad ID (nid) is needed, but is not available in pass data or passed as an argument&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">nid</span>



        <span class="c1">#</span>
        <span class="c1"># Check timestamp</span>
        <span class="c1">#</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tstamps</span> <span class="o">=</span> <span class="p">[</span><span class="n">ephem</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pass_data</span><span class="o">.</span><span class="n">tstamp_str</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Badly formatted date(s) in pass_data.tstamp_str: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="n">pass_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">tstamps</span>
        <span class="n">pass_data</span><span class="o">.</span><span class="n">tstamp_str</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tstamps</span><span class="p">]</span>

        <span class="c1"># Crop data to only contain waht is above the horizon</span>
        <span class="n">pass_data</span> <span class="o">=</span> <span class="n">pass_data</span><span class="p">[</span><span class="n">pass_data</span><span class="o">.</span><span class="n">el</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">pass_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Pass never comes above visibility horizon&#39;</span><span class="p">)</span>

        <span class="c1"># While strictly not necessay, not curating what gets stored in the commspass</span>
        <span class="c1"># makes it difficult to do automated testing. So this will need to be edited</span>
        <span class="c1"># if in the future we need anything more</span>
        <span class="n">pass_data</span> <span class="o">=</span> <span class="n">pass_data</span><span class="p">[[</span><span class="s1">&#39;tstamp_str&#39;</span><span class="p">,</span> <span class="s1">&#39;az&#39;</span><span class="p">,</span> <span class="s1">&#39;el&#39;</span><span class="p">,</span> <span class="s1">&#39;range_rate&#39;</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span> <span class="o">=</span> <span class="n">pass_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comms</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">comm</span> <span class="ow">in</span> <span class="n">comms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_communication</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span>

        <span class="c1"># Add any additional metadata fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>





    <span class="k">def</span> <span class="nf">_change_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tstamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Debugging function: Adjusts the timestamp as required</span>
<span class="sd">        If you run this it will not correspond to a real satellite anymore</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">curt</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">newt</span> <span class="o">=</span> <span class="n">ephem</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">tstamp</span><span class="p">)</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">newt</span><span class="o">-</span><span class="n">curt</span><span class="p">)</span>
        <span class="n">newindex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="n">dt</span><span class="p">)</span>


        <span class="n">s</span> <span class="o">=</span> <span class="n">newindex</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">ephem</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>


        <span class="n">new_pass_data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span>\
            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">tstamp_str</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span>
                <span class="n">az</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">az</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="n">el</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">el</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="n">range_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">range_rate</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span> <span class="o">=</span> <span class="n">new_pass_data</span>






    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Communication Pass:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  Norad ID:       </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nid</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  Description:    </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  Visib. horizon: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">horizon</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  Pass start:     </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">tstamp_str</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  Pass end:       </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">tstamp_str</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="c1">#        for k,v in self._metadata.items():</span>
<span class="c1">#            s += &quot;  {:16s}{:s}\n&quot;.format(str(k),str(v))</span>

        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  Scheduled comms:</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">listen</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;   (listen mode)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;   (no comms added but NOT listen mode)&quot;</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comms</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;retries&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">99</span><span class="p">:</span>
                <span class="n">retrstr</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%10s</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;retries&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">retrstr</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%2d</span><span class="s1"> retries)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;retries&#39;</span><span class="p">])</span>


            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Action</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;   </span><span class="si">%3d</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> : &#39;</span><span class="si">%s</span><span class="s2">&#39; &lt;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">retrstr</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">],</span>  <span class="n">v</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;wait&#39;</span><span class="p">]:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;   </span><span class="si">%3d</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">retrstr</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;hexstr&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;   </span><span class="si">%3d</span><span class="s2"> (no wait)    : </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;hexstr&#39;</span><span class="p">]))</span>

        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        x == y should be true if everything is identical</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="p">[</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">nid</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">nid</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">pass_data</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">horizon</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">horizon</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">comms</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">comms</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_metadata</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">overlaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">buffertime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if current pass overlaps with another pass.</span>

<span class="sd">        By overlap is meant that the other pass begins within a</span>
<span class="sd">        defined buffertime of the current pass finishing.</span>

<span class="sd">        Args:</span>
<span class="sd">            other (CommsPass): The pass to compare with</span>
<span class="sd">            buffertime (float): The time in seconds to allow as a minimum between passes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rt0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tstamp_str</span><span class="p">)</span>
        <span class="n">st0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tstamp_str</span><span class="p">)</span>
        <span class="n">rt1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tstamp_str</span><span class="p">)</span>
        <span class="n">st1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tstamp_str</span><span class="p">)</span>

        <span class="n">btime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">seconds</span> <span class="o">=</span> <span class="n">buffertime</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>   <span class="p">((</span><span class="n">rt0</span> <span class="o">&lt;</span> <span class="n">rt1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">st0</span> <span class="o">+</span> <span class="n">btime</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rt1</span><span class="p">))</span>
            <span class="ow">or</span> <span class="p">((</span><span class="n">rt1</span> <span class="o">&lt;</span> <span class="n">rt0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">st1</span> <span class="o">+</span> <span class="n">btime</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rt0</span><span class="p">))):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__cmp__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">other</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>


    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make it possible to access metadata directly through . operator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; object has no attribute &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make it possible to access metadata directly through . operator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>


    <span class="c1">#</span>
    <span class="c1"># Add some helper methods to make the class pickle-able</span>
    <span class="c1"># It doesnt work out of the box because of our fiddling with __getattr__ and __setattr__</span>
    <span class="c1"># So we will make it use by keeping the state as the dict version instead.</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_metadata&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">CommsPass</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">_metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">pass_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comms</span>     <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">comms</span>
    <span class="c1">########################################################</span>



    <span class="k">def</span> <span class="nf">add_communication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Add a communication to the pass. The communication can be supplied</span>
<span class="sd">            either as a string of HEX-pairs, as a bytearray, or as a Communications</span>
<span class="sd">            object.</span>

<span class="sd">            If a HEX string or a bytearray is supplied, it will be converted to a</span>
<span class="sd">            Communication object internally</span>

<span class="sd">        Args:</span>
<span class="sd">            comm:       The communication to add (either a hex string AB-CD-01-..., or a Communication object or an Action</span>
<span class="sd">                        object</span>
<span class="sd">            **kwargs:   Extra arguments passed to :class:`Communication` constructor in case comm is a hex string.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">Communication</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;No kwargs expected for Communication object, got </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">comms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">Action</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;No kwargs expected for Action object, got </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">comms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span>


        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Communication</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Invalid type for comms object: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">comm</span><span class="p">)))</span>



        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">listen</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cannot use listen mode when communicating. listen mode disabled&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listen</span> <span class="o">=</span> <span class="kc">False</span>


    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualise the pass</span>
<span class="sd">        NOT IMPLEMENTED</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert class to a python dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">pass_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="n">comms</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comms</span><span class="p">],</span>
            <span class="n">_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a copy of the class instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="n">CommsPass</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classmethod to create CommsPass object from a python dict.</span>

<span class="sd">        Usage:</span>
<span class="sd">            &gt;&gt;&gt; cp = CommsPass.from_dict(dict_repr)</span>

<span class="sd">        Arg:</span>
<span class="sd">            d (dict): dictionary</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pass_data</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;pass_data&#39;</span><span class="p">],</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tstamp_str&#39;</span><span class="p">,</span> <span class="s1">&#39;az&#39;</span><span class="p">,</span> <span class="s1">&#39;el&#39;</span><span class="p">,</span> <span class="s1">&#39;range_rate&#39;</span><span class="p">])</span>
        <span class="n">pass_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pass_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">comms</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;comms&#39;</span><span class="p">]</span>

        <span class="c1">#################################</span>
        <span class="c1"># Allow backwards compatability</span>
        <span class="c1"># TODO: Remote and replace with just:</span>
        <span class="c1"># _metadata = d[&#39;_metadata&#39;]</span>
        <span class="c1">#</span>
        <span class="n">_metadata</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;comms&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;pass_data&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;_metadata&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">del</span> <span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">]</span>
            <span class="n">_metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;_metadata&#39;</span><span class="p">])</span>
        <span class="c1">#################################</span>


        <span class="n">cpass</span> <span class="o">=</span> <span class="n">CommsPass</span><span class="p">(</span><span class="n">pass_data</span><span class="p">,</span> <span class="o">**</span><span class="n">_metadata</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comms</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;args&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;kwargs&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;desc&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;retries&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">cpass</span><span class="o">.</span><span class="n">add_communication</span><span class="p">(</span><span class="n">Action</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">],</span> <span class="n">retries</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;retries&#39;</span><span class="p">],</span> <span class="n">desc</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="s1">&#39;hexstr&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;retries&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;wait&#39;</span><span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">cpass</span><span class="o">.</span><span class="n">add_communication</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;hexstr&#39;</span><span class="p">],</span> <span class="n">retries</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;retries&#39;</span><span class="p">],</span> <span class="n">wait</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;wait&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Invalid dict input to from_dict. Expected either Action or Communication in dict form, got </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cpass</span>

    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the class to JSON representation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classmethod to Create CommsPass from a json string or from a json file.</span>

<span class="sd">        Usage:</span>
<span class="sd">            &gt;&gt;&gt; cp = CommsPass.from_dict(json_repr or json_file)</span>

<span class="sd">        Arg:</span>
<span class="sd">            json (fname or string): json string or file to load</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">Schedule</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to hold a schedule of passes</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="p">[],</span> <span class="n">buffertime</span> <span class="o">=</span> <span class="n">SCHEDULE_BUFFERTIME</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Args:</span>
<span class="sd">                passes (list(CommsPass)): List of CommsPass objects</span>
<span class="sd">                buffertime (int, optional) : number of seconds to allow, as a minimum</span>
<span class="sd">                    between two passes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#</span>
        <span class="c1"># sorting can be disabled, but there is no obvious reason</span>
        <span class="c1"># why you would do that. It may also not be safe</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_passes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffertime</span> <span class="o">=</span> <span class="n">buffertime</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">passes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">passes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_pass</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span>  <span class="s1">&#39;Schedule of communication passes:</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  ---- -------- -------------------- -------------------- --------------</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  #    Norad id Pass start (utc)     Pass end (utc)       Communications</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  ---- -------- -------------------- -------------------- --------------</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">passes</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  </span><span class="si">%04d</span><span class="s1"> </span><span class="si">%-8s</span><span class="s1"> </span><span class="si">%-20s</span><span class="s1"> </span><span class="si">%-20s</span><span class="s1"> </span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">nid</span><span class="p">),</span>
                <span class="n">p</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">tstamp_str</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">p</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">tstamp_str</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">comms</span><span class="p">))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  ---- -------- -------------------- -------------------- --------------</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">passes</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">p</span><span class="o">.</span><span class="n">nid</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">tstamp_str</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">tstamp_str</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">comms</span><span class="p">))]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span>\
            <span class="n">rows</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Norad id&#39;</span><span class="p">,</span> <span class="s1">&#39;Pass start (utc)&#39;</span><span class="p">,</span> <span class="s1">&#39;Pass end (utc)&#39;</span><span class="p">,</span> <span class="s1">&#39;Communications&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">_repr_html_</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        x == y should be true if everything is identical</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a copy of the Schedule instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="n">Schedule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()))</span>


    <span class="k">def</span> <span class="nf">add_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpass</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a pass to the schedule</span>

<span class="sd">        Args:</span>
<span class="sd">            tpass: The CommsPass instance to add</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check for overlap. Raises exception if overlap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_overlap</span><span class="p">(</span><span class="n">tpass</span><span class="p">)</span>

        <span class="c1">#if all good, add</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpass</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_passes</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">pass_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">remove_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpass</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a CommsPass instance from the schedule</span>

<span class="sd">        Args:</span>
<span class="sd">            tpass: The instance to remove</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tpass</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pop the n&#39;th pass from the schedule</span>

<span class="sd">        Args:</span>
<span class="sd">            index: The index (or list of indexes) to pop</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpass</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">tpass</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">buffertime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buffertime</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">passes</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t add pass as it overlaps with another pass in the schedule&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert schedule to its python dictionary representation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">passes</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">passes</span><span class="p">],</span>
            <span class="n">sort_passes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_passes</span><span class="p">,</span>
            <span class="n">buffertime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffertime</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert schedule to its json  representation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classmethod to Create Schedule object from a python dict</span>

<span class="sd">        Arg:</span>
<span class="sd">            d (dict): dictionary</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">passes</span> <span class="o">=</span> <span class="p">[</span><span class="n">CommsPass</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;passes&#39;</span><span class="p">]]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Schedule</span><span class="p">(</span><span class="n">passes</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;buffertime&#39;</span><span class="p">])</span>
        <span class="n">s</span><span class="o">.</span><span class="n">sort_passes</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sort_passes&#39;</span><span class="p">]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classmethod to create Schedule from a json string or from a json file.</span>

<span class="sd">        Arg:</span>
<span class="sd">            json (fname or string): json string or file to load</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">RPCSchedulerClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The RPCSchedulerClient class connects to a remote scheduler and allows basic interaction with it to</span>
<span class="sd">    upload/start/stop schedules.</span>

<span class="sd">    For futher information see :class:`libgs.scheduler.Scheduler`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule</span><span class="p">,</span> <span class="n">track_full_pass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute_ant_points</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">rpcaddr</span><span class="o">=</span><span class="s1">&#39;http://localhost:8000&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            schedule:           The schedule to execute</span>
<span class="sd">            track_full_pass:    If True (default), a pass will be tracked to its end even when the communications are finished.</span>
<span class="sd">            compute_ant_points: If True (default), libgs will intelligently decide when to move the antenna based on its beamwidth.</span>
<span class="sd">                                Otherwise the schedule will be followed slavishly.</span>
<span class="sd">            rpcaddr:            The XMLRPC address of the remote. For example: http://some.address.com:8000</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rpcaddr</span> <span class="o">=</span>  <span class="n">rpcaddr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_full_pass</span> <span class="o">=</span> <span class="n">track_full_pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ant_points</span> <span class="o">=</span> <span class="n">compute_ant_points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">RPCClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rpcaddr</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule</span> <span class="o">=</span> <span class="n">schedule</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get current scheduler state from remote</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">scheduler_state</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the schedule on the remote</span>

<span class="sd">        Args:</span>
<span class="sd">            N (optional) : Only execute at most N entries</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">execute_schedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_schedule</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_full_pass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ant_points</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop the scheduler on the remote</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">stop_schedule</span><span class="p">()</span>

<div class="viewcode-block" id="RPCSchedulerClient.enable"><a class="viewcode-back" href="../../_autosummary/libgs_ops.scheduling.RPCSchedulerClient.enable.html#libgs_ops.scheduling.RPCSchedulerClient.enable">[docs]</a>    <span class="k">def</span> <span class="nf">enable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Re-enable a disabled scheduler on the remote</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span></div>

<div class="viewcode-block" id="RPCSchedulerClient.disable"><a class="viewcode-back" href="../../_autosummary/libgs_ops.scheduling.RPCSchedulerClient.disable.html#libgs_ops.scheduling.RPCSchedulerClient.disable">[docs]</a>    <span class="k">def</span> <span class="nf">disable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disable a scheduler on the remote. It will not be possible to send it schedules or execute schedules before</span>
<span class="sd">        it is re-enabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Attributes can be found here: https://docs.python.org/2/library/logging.html#logrecord-attributes</span>
        <span class="c1">#</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)5s</span><span class="s1"> - </span><span class="si">%(module)10s</span><span class="s1"> - &quot;</span><span class="si">%(message)s</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

        <span class="c1"># add formatter to ch</span>
        <span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

        <span class="c1"># add ch to logger</span>
        <span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>


</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, UNSW

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>